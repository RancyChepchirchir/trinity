// http://www.pubmap.co.uk/ Version 0.6.0. Copyright 2018 John Walley.
!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],r):r(t.d3=t.d3||{},t.d3)}(this,function(t,j){"use strict";function Q(t,r,e,n,a){for(var o,s,i,l,c,d="",h=t.nodes,f=r(1)-r(0),u=Math.sqrt(2),p=[t.shiftCoords[0]*n/f,t.shiftCoords[1]*n/f],b="diagonal",m=0;m<h.length;m++)if(0<m){o=h[m],s=h[m-1];i=Math.round(s.coords[0]-o.coords[0]),l=Math.round(s.coords[1]-o.coords[1]);var y=[0,0];if(m===h.length-1&&(0==i||0==l?(0<i&&(y=[-n/(2*a*f),0]),i<0&&(y=[n/(2*a*f),0]),0<l&&(y=[0,-n/(2*a*f)]),l<0&&(y=[0,n/(2*a*f)])):(0<i&&0<l&&(y=[-n/(2*a*f*u),-n/(2*a*f*u)]),0<i&&l<0&&(y=[-n/(2*a*f*u),n/(2*a*f*u)]),i<0&&0<l&&(y=[n/(2*a*f*u),-n/(2*a*f*u)]),i<0&&l<0&&(y=[n/(2*a*f*u),n/(2*a*f*u)]))),c=[[r(s.coords[0]+p[0]),e(s.coords[1]+p[1])],[r(o.coords[0]+p[0]+y[0]),e(o.coords[1]+p[1]+y[1])]],0==i||0==l)b="udlr",d+="L"+c[1][0]+","+c[1][1];else if(Math.abs(i)==Math.abs(l)&&1<Math.abs(i))b="diagonal",d+="L"+c[1][0]+","+c[1][1];else if(1==Math.abs(i)&&1==Math.abs(l))switch(o.dir.toLowerCase()){case"e":d+="Q"+c[1][0]+","+c[0][1]+","+c[1][0]+","+c[1][1];break;case"s":case"n":d+="Q"+c[0][0]+","+c[1][1]+","+c[1][0]+","+c[1][1];break;case"w":d+="Q"+c[1][0]+","+c[0][1]+","+c[1][0]+","+c[1][1]}else if(1==Math.abs(i)&&2==Math.abs(l)||2==Math.abs(i)&&1==Math.abs(l)){var g;1==i?"udlr"==b?g=[c[0][0],c[0][1]+(c[1][1]-c[0][1])/2]:"diagonal"==b&&(g=[c[1][0],c[0][1]+(c[1][1]-c[0][1])/2]):-1==i?"udlr"==b?g=[c[0][0],c[0][1]+(c[1][1]-c[0][1])/2]:"diagonal"==b&&(g=[c[1][0],c[0][1]+(c[1][1]-c[0][1])/2]):-2==i?"udlr"==b?g=[c[0][0]+(c[1][0]-c[0][0])/2,c[0][1]]:"diagonal"==b&&(g=[c[0][0]+(c[1][0]-c[0][0])/2,c[1][1]]):2==i&&("udlr"==b?g=[c[0][0]+(c[1][0]-c[0][0])/2,c[0][1]]:"diagonal"==b&&(g=[c[0][0]+(c[1][0]-c[0][0])/2,c[1][1]])),d+="C"+g[0]+","+g[1]+","+g[0]+","+g[1]+","+c[1][0]+","+c[1][1]}}else{o=h[m+1],s=h[m],i=Math.round(s.coords[0]-o.coords[0]),l=Math.round(s.coords[1]-o.coords[1]);var k=[0,0];0==i||0==l?(0<i&&(k=[n/(2*a*f),0]),i<0&&(k=[-n/(2*a*f),0]),0<l&&(k=[0,n/(2*a*f)]),l<0&&(k=[0,-n/(2*a*f)])):(0<i&&0<l&&(k=[n/(2*a*f*u),n/(2*a*f*u)]),0<i&&l<0&&(k=[n/(2*a*f*u),-n/(2*a*f*u)]),i<0&&0<l&&(k=[-n/(2*a*f*u),n/(2*a*f*u)]),i<0&&l<0&&(k=[-n/(2*a*f*u),-n/(2*a*f*u)])),d+="M"+(c=[r(s.coords[0]+p[0]+k[0]),e(s.coords[1]+p[1]+k[1])])[0]+","+c[1]}return d}function F(t){this.lines=t}function R(t){this.stations=t}R.prototype.toArray=function(){var t=[];for(var r in this.stations)if(this.stations.hasOwnProperty(r)){var e=this.stations[r];e.name=r,t.push(e)}return t},R.prototype.interchanges=function(){return this.toArray().filter(function(t){return"interchange"===t.marker[0].marker})},R.prototype.normalStations=function(){var t=this.toArray().filter(function(t){return"interchange"!==t.marker[0].marker}),e=[];return t.forEach(function(r){r.marker.forEach(function(t){e.push({name:r.name,line:t.line,x:r.x,y:r.y,color:t.color,shiftX:t.shiftX,shiftY:t.shiftY,labelPos:r.labelPos})})}),e},t.tubeMap=function(){var w,v,C,x,P={top:80,right:80,bottom:20,left:80},M=760,O=640,S=j.scaleLinear(),A=j.scaleLinear(),X=.8,Y=1.5,E=j.dispatch("click");function r(k){k.each(function(t){var r,e,a,n,o,s;C={raw:(r=t).lines,river:r.river,stations:(o=r,o.lines.forEach(function(t){for(var r=0;r<t.nodes.length;r++){var e=t.nodes[r];if(e.hasOwnProperty("name")){if(!o.stations.hasOwnProperty(e.name))throw new Error("Cannot find station with key: "+e.name);var n=o.stations[e.name];n.x=e.coords[0],n.y=e.coords[1],void 0===n.labelPos&&(n.labelPos=e.labelPos,n.labelShiftX=e.hasOwnProperty("labelShiftCoords")?e.labelShiftCoords[0]:e.hasOwnProperty("shiftCoords")?e.shiftCoords[0]:t.shiftCoords[0],n.labelShiftY=e.hasOwnProperty("labelShiftCoords")?e.labelShiftCoords[1]:e.hasOwnProperty("shiftCoords")?e.shiftCoords[1]:t.shiftCoords[1]),e.hasOwnProperty("canonical")&&(n.labelPos=e.labelPos,n.labelShiftX=e.hasOwnProperty("labelShiftCoords")?e.labelShiftCoords[0]:e.hasOwnProperty("shiftCoords")?e.shiftCoords[0]:t.shiftCoords[0],n.labelShiftY=e.hasOwnProperty("labelShiftCoords")?e.labelShiftCoords[1]:e.hasOwnProperty("shiftCoords")?e.shiftCoords[1]:t.shiftCoords[1]),n.label=o.stations[e.name].label,n.position=o.stations[e.name].position,n.visited=!1,e.hide||(n.marker=n.marker||[],n.marker.push({line:t.name,color:t.color,labelPos:e.labelPos,marker:e.hasOwnProperty("marker")?e.marker:"station",shiftX:e.hasOwnProperty("shiftCoords")?e.shiftCoords[0]:t.shiftCoords[0],shiftY:e.hasOwnProperty("shiftCoords")?e.shiftCoords[1]:t.shiftCoords[1]}))}}}),s=o.stations,new R(s)),lines:(e=r.lines,a=[],e.forEach(function(t){var r={name:t.name,title:t.label,stations:[],color:t.color,shiftCoords:t.shiftCoords,nodes:t.nodes,highlighted:!1};a.push(r);for(var e=0;e<t.nodes.length;e++){var n=t.nodes[e];n.hasOwnProperty("name")&&r.stations.push(n.name)}}),n=a,new F(n))};var i,l,c,d,h,f=j.min(C.raw,function(t){return j.min(t.nodes,function(t){return t.coords[0]})}),u=j.max(C.raw,function(t){return j.max(t.nodes,function(t){return t.coords[0]})}),p=j.min(C.raw,function(t){return j.min(t.nodes,function(t){return t.coords[1]})}),b=j.max(C.raw,function(t){return j.max(t.nodes,function(t){return t.coords[1]})}),m=(u-f)/(b-p),y=(M-P.left-P.right)/(O-P.top-P.bottom),g=y/m;y<m?(i=M-P.left-P.right,l=(O-P.top-P.bottom)*g):(i=(M-P.left-P.right)/g,l=O-P.top-P.bottom),S.domain([f,u]).range([P.left,P.left+i]),A.domain([p,b]).range([P.top+l,P.top]),w=X*(S(1)-S(0)),v=k.append("svg").style("width","100%").style("height","100%"),x=v.append("g"),void 0!==C.river&&x.append("g").attr("class","river").selectAll("path").data([C.river]).enter().append("path").attr("d",function(t){return Q(t,S,A,w,Y)}).attr("stroke","#CCECF4").attr("fill","none").attr("stroke-width",1.8*w),x.append("g").attr("class","lines").selectAll("path").data(C.lines.lines).enter().append("path").attr("d",function(t){return Q(t,S,A,w,Y)}).attr("id",function(t){return t.name}).attr("stroke",function(t){return t.color}).attr("fill","none").attr("stroke-width",function(t){return t.highlighted?1.3*w:w}).classed("line",!0),c="#000000",d="#ffffff",x.append("g").attr("class","interchanges").selectAll("path").data(C.stations.interchanges()).enter().append("g").attr("id",function(t){return t.name}).on("click",function(){var t=j.select(this),r=t.attr("id");E.call("click",this,r)}).append("path").attr("d",(h=w,j.arc().innerRadius(0).outerRadius(1.25*h).startAngle(0).endAngle(2*Math.PI))).attr("transform",function(t){return"translate("+S(t.x+t.marker[0].shiftX*X)+","+A(t.y+t.marker[0].shiftY*X)+")"}).attr("stroke-width",w/2).attr("fill",function(t){return t.visited?c:d}).attr("stroke",function(t){return t.visited?d:c}).classed("interchange",!0).style("cursor","pointer"),x.append("g").attr("class","stations").selectAll("path").data(C.stations.normalStations()).enter().append("g").attr("id",function(t){return t.name}).on("click",function(){var t=j.select(this),r=t.attr("id");E.call("click",this,r)}).append("path").attr("d",function(t){return function(t,r,e,n,a){var o,s=Math.sqrt(2),i=j.line().x(function(t){return r(t[0])}).y(function(t){return e(t[1])});switch(t.labelPos.toLowerCase()){case"n":o=[0,1];break;case"ne":o=[1/s,1/s];break;case"e":o=[1,0];break;case"se":o=[1/s,-1/s];break;case"s":o=[0,-1];break;case"sw":o=[-1/s,-1/s];break;case"w":o=[-1,0];break;case"nw":o=[-1/s,1/s]}return i([[t.x+t.shiftX*n+n/2.05*o[0],t.y+t.shiftY*n+n/2.05*o[1]],[t.x+t.shiftX*n+n/2*o[0]+n/a*o[0],t.y+t.shiftY*n+n/2*o[1]+n/a*o[1]]])}(t,S,A,X,Y)}).attr("stroke",function(t){return t.color}).attr("stroke-width",w/Y).attr("fill","none").attr("class",function(t){return t.line}).attr("id",function(t){return t.name}).classed("station",!0),x.append("g").attr("class","labels").selectAll("text").data(C.stations.toArray()).enter().append("g").attr("id",function(t){return t.name}).classed("label",!0).on("click",function(){var t=j.select(this),r=t.attr("id");E.call("click",this,r)}).append("text").text(function(t){return t.label}).attr("fill","#10137E").attr("dy",.1).attr("x",function(t){return S(t.x+t.labelShiftX)+L(t).pos[0]}).attr("y",function(t){return A(t.y+t.labelShiftY)-L(t).pos[1]}).attr("text-anchor",function(t){return L(t).textAnchor}).style("display",function(t){return!0!==t.hide?"block":"none"}).style("font-size",w+"px").style("-webkit-user-select","none").attr("class",function(t){return t.marker.map(function(t){return t.line}).join(" ")}).classed("highlighted",function(t){return t.visited}).call(q)})}function L(t){var r,e,n=1.8*w,a=t.label.split(/\n/).length,o=Math.sqrt(2);switch(t.labelPos.toLowerCase()){case"n":r=[0,w*(a-1)+n],e="middle";break;case"ne":r=[n/o,(w*(a-1)+n)/o],e="start";break;case"e":r=[n,0],e="start";break;case"se":r=[n/o,-1.4*n/o],e="start";break;case"s":r=[0,-1.4*X*n],e="middle";break;case"sw":r=[-n/o,-1.4*n/o],e="end";break;case"w":r=[-n,0],e="end";break;case"nw":r=[-(w*(a-1)+n)/o,(w*(a-1)+n)/o],e="end"}return{pos:r,textAnchor:e}}function q(t){t.each(function(){var t=j.select(this),r=t.text().split(/\n/),e=t.attr("y"),n=t.attr("x"),a=parseFloat(t.attr("dy"));t.text(null).append("tspan").attr("x",n).attr("y",e).attr("dy",a+"em").text(r[0]);for(var o=1;o<r.length;o++)t.append("tspan").attr("x",n).attr("y",e).attr("dy",1.1*o+a+"em").text(r[o])})}return r.width=function(t){return arguments.length?(M=t,r):M},r.height=function(t){return arguments.length?(O=t,r):O},r.margin=function(t){return arguments.length?(P=t,r):P},r.on=function(){var t=E.on.apply(E,arguments);return t===E?r:t},r},Object.defineProperty(t,"__esModule",{value:!0})});